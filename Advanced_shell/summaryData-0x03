#!/bin/bash

# This script generates a CSV report of Pokémon data and calculates average height and weight.

# The directory where the Pokémon data is stored
DATA_DIR="pokemon_data"

# The output CSV file
CSV_FILE="pokemon_report.csv"

# Check if the data directory exists
if [ ! -d "$DATA_DIR" ]; then
  echo "Error: Directory $DATA_DIR not found. Please run the batchProcessing-0x02 script first." >&2
  exit 1
fi

# Create the CSV file and add the header
echo "Name,Height (m),Weight (kg)" > "$CSV_FILE"

# Loop through the JSON files in the data directory
for file in "$DATA_DIR"/*.json; do
  # Extract data using jq
  name=$(jq -r '.name' "$file")
  height=$(jq -r '.height' "$file")
  weight=$(jq -r '.weight' "$file")
  
  # Convert height from decimetres to meters and weight from hectograms to kilograms
  height_m=$(echo "$height / 10" | bc -l)
  weight_kg=$(echo "$weight / 10" | bc -l)
  
  # Append the data to the CSV file
  echo "$name,$height_m,$weight_kg" >> "$CSV_FILE"
done

echo "CSV Report generated at: $CSV_FILE"
echo ""

# Use awk to calculate and print the average height and weight
awk -F, 'NR > 1 {
    sum_height += $2;
    sum_weight += $3;
    count++
}
END {
    if (count > 0) {
        printf "Average Height: %.2f m\n", sum_height / count;
        printf "Average Weight: %.2f kg\n", sum_weight / count
    }
}' "$CSV_FILE"
